name: Update JMA Weather Data
  run: |
    python << 'EOF'
    import requests
    import json
    import sys
    from datetime import datetime
    import time

    def classify_weather(text: str) -> str:
        if not text:
            return "不明"
        text = text.strip()
        keywords = [
            ("雪", "雪"),
            ("雷", "雨"),    # 雷雨を雨扱いにする例
            ("雨", "雨"),
            ("曇", "曇り"),  # 「曇り」「時々曇」など
            ("晴", "晴れ"),
        ]
        for kw, label in keywords:
            if kw in text:
                return label
        return "不明"

    base_url = 'https://www.jma.go.jp/bosai/forecast/data/forecast'

    # 修正点: このリストの定義前に、他のPythonコードと同じく
    # YAMLレベルでのインデント（8スペース）を追加しました
    area_codes = [
        '016000',  # 北海道 (※ JSONのキーに合わせています)
        '020000',  # 青森県
        '030000',  # 岩手県
        '040000',  # 宮城県
        '050000',  # 秋田県
        '060000',  # 山形県
        '070000',  # 福島県
        '080000',  # 茨城県
        '090000',  # 栃木県
        '100000',  # 群馬県
        '110000',  # 埼玉県
        '120000',  # 千葉県
        '130000',  # 東京都
        '140000',  # 神奈川県
        '150000',  # 新潟県
        '160000',  # 富山県
        '170000',  # 石川県
        '180000',  # 福井県
        '190000',  # 山梨県
        '200000',  # 長野県
        '210000',  # 岐阜県
        '220000',  # 静岡県
        '230000',  # 愛知県
        '240000',  # 三重県
        '250000',  # 滋賀県
        '260000',  # 京都府
        '270000',  # 大阪府
        '280000',  # 兵庫県
        '290000',  # 奈良県
        '300000',  # 和歌山県
        '310000',  # 鳥取県
        '320000',  # 島根県
        '330000',  # 岡山県
        '340000',  # 広島県
        '350000',  # 山口県
        '360000',  # 徳島県
        '370000',  # 香川県
        '380000',  # 愛媛県
        '390000',  # 高知県
        '400000',  # 福岡県
        '410000',  # 佐賀県
        '420000',  # 長崎県
        '430000',  # 熊本県
        '440000',  # 大分県
        '450000',  # 宮崎県
        '460100',  # 鹿児島県
        '471000',  # 沖縄県
    ]

    results = {
        "updated_at": datetime.utcnow().isoformat() + "Z",
        "areas": {}
    }

    for code in area_codes:
        url = f'{base_url}/{code}.json'
        try:
            response = requests.get(url, timeout=30)
            response.raise_for_status()
            data = response.json()

            current_weather = "不明"

            # timeSeriesを走査して天気情報を抽出
            for series in data[0].get("timeSeries", []):
                if "areas" not in series:
                    continue
                for area in series["areas"]:
                    target_code = area.get("area", {}).get("code")
                    if target_code and target_code != code:
                        continue
                    weather_list = area.get("weathers") or area.get("weatherCodes")
                    if weather_list:
                        weather_text = weather_list[0] if isinstance(weather_list, list) else str(weather_list)
                        current_weather = classify_weather(weather_text)
                        break
                if current_weather != "不明":
                    break

            results["areas"][code] = {
                "weather": current_weather,
                "raw": data[0]  # 必要に応じて詳細を残す
            }
            print(f'{code}: {current_weather}')
        except Exception as e:
            print(f'Error fetching {code}: {e}', file=sys.stderr)

        time.sleep(0.2)  # 負荷軽減

    with open('jma_weather.json', 'w', encoding='utf-8') as f:
        json.dump(results, f, ensure_ascii=False, indent=2)
    EOF
